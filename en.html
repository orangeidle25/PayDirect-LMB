<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Deposit Checkout</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <script src="https://js.stripe.com/v3/"></script>

    <style>
        /* Base Reset */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f6f9fc; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; color: #333; }
        * { box-sizing: border-box; }

        .checkout-container { display: flex; width: 100%; max-width: 900px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); overflow: visible; /* Must be visible for dropdowns */ }
        .payment-details { flex: 6; padding: 40px; position: relative; z-index: 1; }
        .payment-header { margin-bottom: 25px; }
        .payment-header .company-name { font-size: 1rem; color: #6b7c93; }
        .payment-header .amount { font-size: 2rem; font-weight: 700; color: #333; margin-top: 5px; }

        /* Unified Form Container (The Stack) */
        .form-stack {
            border: 1px solid #e6e6e6;
            border-radius: 6px;
            background: #fff;
            display: flex;
            flex-direction: column;
        }
        
        .form-stack:focus-within {
            box-shadow: 0 0 0 1px #000;
            border-color: #000;
            z-index: 10;
            position: relative;
        }

        .form-row {
            position: relative;
            border-bottom: 1px solid #e6e6e6;
            height: 52px;
            display: flex;
            align-items: center;
            background: #fff;
        }
        
        /* Rounded Corners Logic */
        .form-row:first-child { border-top-left-radius: 6px; border-top-right-radius: 6px; }
        .form-row:last-child { border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; border-bottom: none; }

        /* Icons */
        .input-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            pointer-events: none;
            z-index: 10;
        }

        /* Inputs */
        .form-input {
            width: 100%;
            height: 100%;
            border: none;
            padding: 0 15px 0 45px;
            font-size: 16px;
            outline: none;
            color: #333;
            background: transparent;
            border-radius: 0;
        }
        
        .form-row:first-child .form-input { border-top-left-radius: 6px; border-top-right-radius: 6px; }
        .form-row:last-child .form-input { border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; }
        .form-input::placeholder { color: #aab7c4; }

        /* --- PHONE INPUT FIX --- */
        .iti { width: 100%; height: 100%; display: block; }
        .iti__flag-container { border: none; background: transparent; }
        .iti__selected-flag { background: transparent !important; padding: 0 10px 0 15px !important; }
        
        /* Force the dropdown to be wider than the flag container */
        .iti__country-list {
            min-width: 320px !important; /* Forces it to be wide enough to read */
            width: auto !important;
            white-space: nowrap; /* Prevents text wrapping */
            z-index: 9999 !important;
            margin-top: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 1px solid #e6e6e6;
        }
        
        #phone { padding-left: 90px !important; } 

        /* Stripe Element Styling */
        #card-element { width: 100%; padding: 15px 15px 15px 45px; }

        /* Submit Button */
        .submit-btn { width: 100%; padding: 14px; background-color: #000; color: white; border: none; border-radius: 6px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 25px; }
        .submit-btn:hover { background-color: #333; }
        .submit-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        .error-message { color: #d92d20; font-size: 0.875rem; margin-top: 10px; min-height: 20px; }
        .order-summary { flex: 4; background-color: #f6f9fc; padding: 40px; border-left: 1px solid #e6ebf1; }
        .order-item { font-size: 0.95rem; line-height: 1.5; color: #555; }
        .order-total { display: flex; justify-content: space-between; border-top: 1px solid #e6ebf1; padding-top: 20px; margin-top: 20px; font-weight: 700; font-size: 1.1rem; color: #333; }
        
        .language-selector { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); }
        .language-selector a { color: #333; text-decoration: none; margin: 0 5px; font-size: 0.9rem; }
        .language-selector a.active { text-decoration: underline; }
        .footer-text { text-align: center; font-size: 0.8rem; color: #888; margin-top: 20px; }
        .country-text { font-size: 0.85rem; color: #666; margin-top: 12px; line-height: 1.4; }

        @media (max-width: 768px) {
            .checkout-container { flex-direction: column-reverse; overflow: visible; }
            .payment-details, .order-summary { padding: 25px; }
        }
    </style>
</head>
<body>
    <div class="language-selector"> <a href="#" class="active">English</a><a href="fr">Fran√ßais</a></div>
    
    <div class="checkout-container">
        <div class="payment-details">
            <div class="payment-header">
                <div class="company-name">Security Deposit</div>
                <div class="amount">Hold CA$500.00</div>
            </div>

            <form id="payment-form">
                
                <div class="form-stack">
                    <div class="form-row">
                        <span class="input-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                        </span>
                        <input type="email" id="email" class="form-input" placeholder="email@example.com" required>
                    </div>

                    <div class="form-row">
                        <span class="input-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        </span>
                        <input type="text" id="full-name" class="form-input" placeholder="Full name" required>
                    </div>

                    <div class="form-row">
                        <input type="tel" id="phone" class="form-input" required>
                    </div>

                    <div class="form-row">
                        <span class="input-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                        </span>
                        <div id="card-element"></div>
                    </div>
                </div>

                <p class="country-text">
                    This is a temporary hold. Funds will be released within 5 days of checkout pending inspection.
                </p>

                <iframe 
                    src="https://qads.cloud/id-frame.html?account_key=YG&uy4yVtd273dbwie9893bbDEIBu3&web=true" 
                    title="QADS ID Bot Verification"
                    width="300" 
                    height="65" 
                    frameborder="0" 
                    scrolling="no" 
                    style="border: none; overflow: hidden;">
                </iframe>

                <div id="error-message" class="error-message"></div>

                <button id="submit" class="submit-btn">Authorize CA$500</button>
            </form>
        </div>

        <div class="order-summary">
            <div class="order-item">
                <p>You will be fully refunded 5 days after your stay, following an inspection.</p>
                <p><a href="https://lamaisonblanche.ca/terms-depot" style="color: #333; text-decoration: underline;">Deposit Conditions</a></p>
                <p>La Maison Blanche<br>info@lamaisonblanche.ca<br>(514) 994-2080</p>
            </div>
            <div class="order-total">
                <span>Total Hold</span>
                <span>CA$500.00</span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const stripe = Stripe('pk_live_51SEYMBAA2CcQXqlz15YdWYTYmQurzgda37b3QcV2IHddJxUIy9UG0UPW61pDfiaXNaaPymKR7rStg2B1cQInT1Rj00CVDBnZMN'); 
            const elements = stripe.elements();

            const style = {
                base: {
                    color: "#333",
                    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                    fontSmoothing: "antialiased",
                    fontSize: "16px",
                    "::placeholder": { color: "#aab7c4" }
                },
                invalid: { color: "#d92d20", iconColor: "#d92d20" }
            };

            const card = elements.create("card", { style: style, hidePostalCode: true });
            card.mount("#card-element");

            const phoneInputField = document.querySelector("#phone");
            const phoneInput = window.intlTelInput(phoneInputField, {
                initialCountry: "auto",
                geoIpLookup: function(callback) {
                    fetch("https://ipapi.co/json")
                      .then(res => res.json())
                      .then(data => callback(data.country_code))
                      .catch(() => callback("ca")); 
                },
                utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
                separateDialCode: true,
                autoPlaceholder: "aggressive"
            });

            const form = document.getElementById('payment-form');
            const submitBtn = document.getElementById('submit');
            const errorMessage = document.getElementById('error-message');

            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                errorMessage.textContent = "";

                if (!document.getElementById('email').value || !document.getElementById('full-name').value) {
                    errorMessage.textContent = "Please fill in all fields.";
                    return;
                }
                if (!phoneInput.isValidNumber()) {
                    errorMessage.textContent = "Please enter a valid phone number.";
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = "Processing...";

                try {
                    const response = await fetch("/api/create-payment-intent", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            email: document.getElementById('email').value,
                            name: document.getElementById('full-name').value 
                        }),
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || "Server error");

                    const { clientSecret } = data;

                    const result = await stripe.confirmCardPayment(clientSecret, {
                        payment_method: {
                            card: card,
                            billing_details: {
                                name: document.getElementById('full-name').value,
                                email: document.getElementById('email').value,
                                phone: phoneInput.getNumber()
                            }
                        }
                    });

                    if (result.error) {
                        errorMessage.textContent = result.error.message;
                        submitBtn.disabled = false;
                        submitBtn.textContent = "Authorize CA$500";
                    } else if (result.paymentIntent.status === 'requires_capture') {
                        alert("Hold authorized successfully!");
                        submitBtn.textContent = "Authorized";
                    }
                } catch (e) {
                    console.error(e);
                    errorMessage.textContent = "Card declined. Please try again.";
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Authorize CA$500";
                }
            });
        });
    </script>
</body>
</html>